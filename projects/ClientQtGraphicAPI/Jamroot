REDEMPTION_PUBLIC_PATH ?= [ SHELL "readlink -n -f ../.." ] ;

ECHO "redemption-src: $(REDEMPTION_PUBLIC_PATH)" ;

JAM_INCLUDE_PATH ?= $(REDEMPTION_PUBLIC_PATH)/jam ;
REDEMPTION_INCLUDE_PATH ?= $(REDEMPTION_PUBLIC_PATH)/include ;
REDEMPTION_MODULES_SRC_PATH ?= $(REDEMPTION_PUBLIC_PATH)/modules ;

include $(JAM_INCLUDE_PATH)/redemption-config.jam ;
include $(JAM_INCLUDE_PATH)/defines.jam ;

# qt4: bjam -sqt=4
# qt5: bjam -sqt=5

## Qt version {
# select best Qt version
## @{
import os ;
local qtversion = [ os.environ qt ] ;

if ! $(qtversion)
{
    qtversion = [ os.environ qtversion ] ;

    if ! $(qtversion)
    {
        qtversion = [ os.environ KDE_SESSION_VERSION ] ;
        if $(qtversion)
        {
            echo "KDE_SESSION_VERSION=$(qtversion) found. Use Qt$(qtversion)." ;
        }
    }
}

if $(qtversion) != 4 && $(qtversion) != 5
{
    echo "Unknown Qt$(qtversion)." ;
    qtversion = ;
    exit "Please set a valid Qt version (4 or 5) with `bjam -s qt=4`." ;
}
## @}


if $(qtversion) = 4
{
    # TODO search include qt4 directory
    constant QT4_INCLUDE : [ setvar QT4_INCLUDE : /usr/include/qt4 ] ;

    constant QT_INCLUDES : $(QT4_INCLUDE) ;
}

if $(qtversion) = 5
{
    # Need packages qttools5-dev libphonon4qt5-dev
    # TODO search include qt5 directory
    constant QT5_INCLUDE : [ setvar QT5_INCLUDE : /usr/include/x86_64-linux-gnu/qt$(qtversion) ] ;
    # TODO search include phonon directory
    constant QT5_PHONON_INCLUDE : [ setvar QT5_PHONON_INCLUDE : /usr/include/phonon4qt$(qtversion)/phonon ] ;

    constant QT_INCLUDES : $(QT5_INCLUDE) $(QT5_PHONON_INCLUDE) ;
}
## } Qt version


include $(JAM_INCLUDE_PATH)/cxxflags.jam ;
include $(JAM_INCLUDE_PATH)/includes.jam ;
include $(JAM_INCLUDE_PATH)/sanitizer.jam ;

constant NO_FFMPEG : 1 ;
include $(JAM_INCLUDE_PATH)/libs.jam ;


constant SHELL_PWD : $(REDEMPTION_PUBLIC_PATH)/projects/ClientQtGraphicAPI ; # rule location
constant CLIENT_REDEMPTION_MAIN_PATH : [ setvar CLIENT_REDEMPTION_MAIN_PATH : $(SHELL_PWD) ] ;

if $(qtversion) = 4
{
    REDEMPTION_CXXFLAGS +=
        <cxxflags>-Wzero-as-null-pointer-constant&&-Wno-zero-as-null-pointer-constant
    ;
}

project redemption_qt_client
    : requirements

    <conditional>@flags

    $(REDEMPTION_CXXFLAGS)
    $(REDEMPTION_FFMPEG_FLAGS)
    $(REDEMPTION_BOOST_STACKTRACE_FLAGS)

    # <cxxflags>-fPIC
    <variant>debug:<cxxflags>-frtti

    <define>QT_NO_KEYWORDS

    <cxxflags>-isystem$(QT_INCLUDES)

    <toolset>gcc:<cxxflags>-Wno-missing-include-dirs

   : default-build release
;

explicit install instexe install-bin ;

alias instexe : install-bin ;
alias install : install-bin ;

install install-bin
    : client_rdp
    : <install-type>EXE <install-dependencies>on
    : <location>$(INSTALLDIR)/usr/local/bin
    ;

local obj_list = ;

rule add_obj ( target : src : requirements * )
{
    obj $(target) : $(src) : $(requirements) ;
    obj_list += $(target) ;
}

rule add_src ( src : requirements * )
{
    add_obj $(src).o : $(REDEMPTION_SRC_PATH)/$(src) : $(requirements) ;
}

add_obj app_path_exe.o : $(REDEMPTION_SRC_PATH)/core/app_path.cpp :
    <conditional>@defines
    <define>SHARE_PATH='\"$(SHARE_PREFIX)\"'
    <define>CFG_PATH='\"$(REDEMPTION_SYS_PATH)$(CLIENT_REDEMPTION_MAIN_PATH)\"'
;

add_src utils/log_as_logprint.cpp ;

local requirement_list = ;
# generated by `bjam targets.jam` from redemption project
include redemption_deps.jam ;


constant EXE_DEPENDENCIES :
    <define>CLIENT_REDEMPTION_MAIN_PATH='\"$(CLIENT_REDEMPTION_MAIN_PATH)\"'
    <define>REDEMPTION_QT_VERSION=$(qtversion)
;

if $(qtversion) = 4
{
    local CXX_BJAM_YEAR_VERSION = [ modules.peek : JAMVERSION ] ;
    if $(CXX_BJAM_YEAR_VERSION) < 2016.00 {
        using qt : /usr ;
    }
    else {
        using qt4 : /usr ;
    }
    alias libqtclient : /qt//QtGui ;
    alias libphonon : /qt//phonon ;
}
else
{
    using qt5
        : /usr/lib/x86_64-linux-gnu/qt5
        : 5.3
        :
        :
        :
        :
        : $(QT5_INCLUDE)
        : /usr/lib/x86_64-linux-gnu
        ;

    alias libqtclient :
        /qt5//QtGui
        /qt5//QtNetwork
        /qt5//QtWidgets
        /qt5//QtCore
    ;

    lib libphonon : : <name>phonon4qt5 <link>shared ;
}

obj front_Qt$(qtversion)_rdp.o : src/main_qt_client_redemption.cpp :
    <define>REDEMPTION_DECL_LOG_TEST
    $(EXE_DEPENDENCIES)
    <include>$(REDEMPTION_TEST_PATH)/includes # lcg/fixed random
;

exe client_rdp :
    src/qt_input_output_api/qt_output_sound.hpp
    src/qt_input_output_api/qt_input_output_clipboard.hpp
    src/qt_input_output_api/qt_input_socket.hpp
    src/qt_input_output_api/qt_graphics_components/qt_progress_bar_window.hpp
    src/qt_input_output_api/qt_graphics_components/qt_options_window.hpp
    src/qt_input_output_api/qt_graphics_components/qt_screen_window.hpp
    src/qt_input_output_api/qt_graphics_components/qt_form_window.hpp
    front_Qt$(qtversion)_rdp.o
    $(obj_list)
    libqtclient
    # TODO: disable phonon requirement when compiling with -D_NO_SOUND
    libphonon
:
    $(EXE_DEPENDENCIES)
    $(requirement_list)
    # disable moc warnings
    <toolset>gcc:<cxxflags>-Wuseless-cast&&-Wno-useless-cast
    <toolset>clang:<cxxflags>-Wredundant-parens&&-Wno-redundant-parens
;

#obj test_client.o : src/test_client_redemption.cpp :
#    <define>REDEMPTION_DECL_LOG_TEST
#    $(EXE_DEPENDENCIES)
#;
